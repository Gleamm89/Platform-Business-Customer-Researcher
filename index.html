<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VAT / B2B Capture Validator</title>
    <link rel="icon" type="image/png" href="logo.png" />
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --soft:#f8fafc;

      --accent:#7c3aed;
      --accent2:#8b5cf6;
      --accentSoft: rgba(124, 58, 237, .10);

      --good:#16a34a;
      --bad:#dc2626;
      --warn:#d97706;

      --radius:16px;
      --shadow: 0 1px 0 rgba(15,23,42,.04), 0 10px 30px rgba(15,23,42,.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.35;
    }

    .wrap{
      max-width: 1040px;
      margin: 0 auto;
      padding: 22px 16px 64px;
    }

    .top{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap: 10px;
      padding: 8px 0 18px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .brand img{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(124,58,237,.12);
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
    }
    .subline{
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }
    .dot{ opacity:.6 }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fff;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .pill.accent{
      border-color: rgba(124,58,237,.25);
      background: var(--accentSoft);
      color: #4c1d95;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1.05fr .95fr; }
    }

    .section{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .section h2{
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing:.15px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap:wrap;
    }
    .help{
      margin: 0 0 12px;
      font-size: 12px;
      color: var(--muted);
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    input[type="text"], input[type="url"], select, textarea{
      width: 100%;
      border: 1px solid var(--line);
      background: var(--soft);
      border-radius: 12px;
      padding: 10px 11px;
      font-size: 14px;
      outline: none;
    }
    textarea{
      min-height: 92px;
      resize: vertical;
      font-family: var(--mono);
      font-size: 12px;
      background: #fbfbff;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(124,58,237,.45);
      box-shadow: 0 0 0 4px rgba(124,58,237,.12);
      background:#fff;
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .col{
      flex: 1 1 240px;
      min-width: 240px;
    }
    .col.small{
      flex: 0 1 180px;
      min-width: 180px;
    }

    .filebox{
      border: 1px dashed var(--line);
      background: var(--soft);
      border-radius: 12px;
      padding: 12px;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
    }
    .filemeta{
      font-size: 12px;
      color: var(--muted);
    }
    .filetitle{
      font-weight: 800;
      font-size: 13px;
      margin: 0;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 12px;
    }
    button{
      border: 1px solid var(--accent);
      background: var(--accent);
      color:#fff;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      cursor:pointer;
      letter-spacing:.2px;
      box-shadow: 0 10px 22px rgba(124,58,237,.20);
    }
    button:hover{ background: var(--accent2); border-color: var(--accent2); }
    button:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    button.secondary{
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      box-shadow: none;
    }
    button.secondary:hover{
      border-color: rgba(124,58,237,.35);
      color: #4c1d95;
    }

    .statusline{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--line);
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
    }

    /* Output controls */
    .checkgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 700px){
      .checkgrid{ grid-template-columns: 1fr 1fr; }
    }
    .box{
      border: 1px solid var(--line);
      background:#fff;
      border-radius: 12px;
      padding: 10px;
    }
    .box h3{
      margin:0 0 8px;
      font-size: 13px;
    }
    .opt{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding: 6px 0;
      border-top: 1px dashed rgba(226,232,240,.9);
    }
    .opt:first-of-type{ border-top:none; }
    .opt input{ margin-top: 3px; }
    .opt .t{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .opt .name{ font-size: 13px; font-weight: 700; }
    .opt .desc{ font-size: 12px; color: var(--muted); }

    /* Results */
    .kvs{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (min-width: 700px){
      .kvs{ grid-template-columns: 1fr 1fr; }
    }
    .kv{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background:#fff;
    }
    .k{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .v{ font-size: 14px; font-weight: 900; }

    .yn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .yn.good{ border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.08); color: #14532d; }
    .yn.bad{ border-color: rgba(220,38,38,.22); background: rgba(220,38,38,.08); color: #7f1d1d; }
    .yn.warn{ border-color: rgba(217,119,6,.22); background: rgba(217,119,6,.10); color: #7c2d12; }
    .yn.accent{ border-color: rgba(124,58,237,.22); background: rgba(124,58,237,.10); color: #4c1d95; }

    .card2{
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background:#fff;
    }
    .card2 h3{ margin:0 0 8px; font-size: 13px; }
    .mono{ font-family: var(--mono); font-size: 12px; }
    a{ color:#1d4ed8; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    ul{ margin: 8px 0 0; padding-left: 18px; }
    .tiny{ margin-top:8px; font-size: 11px; color: var(--muted); }
    .tagrow{ display:flex; flex-wrap:wrap; gap: 6px; margin-top: 8px; }
    .tag{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(124,58,237,.22);
      background: rgba(124,58,237,.10);
      color:#4c1d95;
    }

    .divider{
      height:1px;
      background: var(--line);
      margin: 12px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <img src="logo.png" alt="logo" onerror="this.src='https://gleamm89.github.io/Bed-Sizes/logo.png'; this.onerror=null;" />
        <h1>VAT / B2B Capture Validator</h1>
      </div>

      <p class="subline">
        Deep-search docs & PDFs • Evidence links • API components • Postman library
        <span class="dot">•</span>
        <span class="pill accent" id="bannerStatus">Waiting for input…</span>
      </p>
    </header>

    <div class="grid">
      <!-- INPUTS -->
      <section class="section">
        <h2>Input <span class="pill"><strong>Minimum:</strong>&nbsp;Platform + Country</span></h2>
        <p class="help">Add docs URLs or upload a PDF for the best results (platform docs may be behind login).</p>

        <div class="row">
          <div class="col small">
            <label for="country">Country (minimum)</label>
            <select id="country">
              <option value="">Select…</option>
              <option>DE</option><option>NL</option><option>BE</option><option>FR</option><option>ES</option><option>IT</option>
              <option>PL</option><option>SE</option><option>AT</option><option>DK</option><option>FI</option><option>IE</option>
              <option>PT</option><option>CZ</option><option>HU</option><option>RO</option><option>BG</option><option>GR</option>
              <option>SK</option><option>SI</option><option>HR</option><option>EE</option><option>LV</option><option>LT</option>
              <option>LU</option><option>MT</option><option>CY</option>
              <option>UK</option><option>NO</option><option>CH</option>
              <option>US</option><option>CA</option><option>AU</option>
            </select>
          </div>

          <div class="col">
            <label for="platform">Platform name (minimum)</label>
            <input id="platform" type="text" placeholder="Amazon, bol.com, OTTO, …" />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <label for="devSite">API developer site (optional)</label>
            <input id="devSite" type="url" placeholder="https://developer.example.com/…" />
          </div>
          <div class="col">
            <label for="docsUrl">Docs URL (optional)</label>
            <input id="docsUrl" type="url" placeholder="https://…/docs/… (VAT / invoicing / buyer fields)" />
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="filebox" id="dropZone">
            <div>
              <p class="filetitle">Upload developer documentation PDF (optional)</p>
              <div class="filemeta" id="pdfMeta">No file selected.</div>
            </div>
            <div>
              <input id="pdfFile" type="file" accept="application/pdf" style="display:none" />
              <button class="secondary" id="choosePdfBtn" type="button">Upload PDF</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="e.g. 'Legacy integration treated B2B as B2C; we need VAT capture + business buyer identification for tax logic.'"></textarea>
        </div>

        <div class="divider"></div>

        <!-- ✅ Selection boxes requested -->
        <h2>Selection boxes for output</h2>
        <p class="help">Choose what the AI should look for, and which blocks to show in the Outcome panel.</p>

        <div class="checkgrid">
          <div class="box">
            <h3>Validation targets (what to find)</h3>

            <div class="opt">
              <input type="checkbox" id="tVat" checked />
              <div class="t">
                <div class="name">VAT number capture</div>
                <div class="desc">Fields/endpoints/UI inputs for VAT ID / tax ID.</div>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" id="tB2b" checked />
              <div class="t">
                <div class="name">Business customer identification</div>
                <div class="desc">Buyer type, company fields, business account flags.</div>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" id="tInvoice" />
              <div class="t">
                <div class="name">Invoice / billing address model</div>
                <div class="desc">Invoice entity, billing company name, invoice VAT rules.</div>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" id="tTaxLogic" />
              <div class="t">
                <div class="name">Tax logic / exemptions</div>
                <div class="desc">Reverse charge / VAT exemption / OSS/IOSS notes.</div>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" id="tExamples" />
              <div class="t">
                <div class="name">Examples / payloads</div>
                <div class="desc">Sample requests/responses that show VAT/B2B signals.</div>
              </div>
            </div>
          </div>

          <div class="box">
            <h3>Outcome blocks (what to show)</h3>

            <div class="opt">
              <input type="checkbox" id="oYesNo" checked />
              <div class="t">
                <div class="name">Yes/No statements</div>
                <div class="desc">Found? Possible? VAT supported? B2B flag supported?</div>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" id="oLinks" checked />
              <div class="t">
                <div class="name">Hyperlinks / Evidence</div>
                <div class="desc">Links to docs where the info was found.</div>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" id="oComponents" checked />
              <div class="t">
                <div class="name">API & Components</div>
                <div class="desc">Endpoints, fields, UI components related to VAT/B2B capture.</div>
              </div>
            </div>

            <div class="opt">
              <input type="checkbox" id="oPostman" checked />
              <div class="t">
                <div class="name">Postman library</div>
                <div class="desc">Link to Postman collection/workspace or generated collection URL.</div>
              </div>
            </div>

            <div class="opt">
              <label for="depth" style="margin:0; font-weight:700; color:var(--text)">Search depth</label>
              <select id="depth">
                <option value="normal" selected>Normal (fast)</option>
                <option value="deep">Deep (more pages, slower)</option>
                <option value="pdf_only">PDF only (no web fetch)</option>
                <option value="links_only">Links only (no crawling)</option>
              </select>
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="runBtn" type="button">Execute</button>
          <button id="resetBtn" class="secondary" type="button">Reset</button>

          <span class="pill"><strong>Status:</strong>&nbsp;<span id="statusText">idle</span></span>
          <span class="pill"><strong>Endpoint:</strong>&nbsp;<span class="mono">POST /api/analyze</span></span>
        </div>

        <div class="statusline">
          <span class="pill accent"><strong>Mode:</strong>&nbsp;<span id="modeText">deep search (docs + pdf)</span></span>
          <span class="pill"><strong>Saved:</strong>&nbsp;inputs persist locally</span>
        </div>
      </section>

      <!-- RESULTS -->
      <section class="section">
        <h2>Outcome</h2>
        <p class="help">Results change based on the selected output blocks and targets.</p>

        <div class="actions" style="margin-top:0">
          <span class="yn accent"><strong>Run ID:</strong>&nbsp;<span id="runId">—</span></span>
          <span class="yn" id="confidenceBadge"><strong>Confidence:</strong>&nbsp;<span id="confidence">—</span></span>
        </div>

        <!-- YES/NO BLOCK -->
        <div id="blkYesNo">
          <div class="kvs">
            <div class="kv">
              <div class="k">Information found?</div>
              <div class="v" id="foundInfo">—</div>
            </div>
            <div class="kv">
              <div class="k">Possibility exists?</div>
              <div class="v" id="possible">—</div>
            </div>
            <div class="kv">
              <div class="k">VAT capture supported?</div>
              <div class="v" id="vatCapture">—</div>
            </div>
            <div class="kv">
              <div class="k">Business customer flag supported?</div>
              <div class="v" id="b2bFlag">—</div>
            </div>
          </div>
        </div>

        <div class="card2">
          <h3>Summary</h3>
          <div class="help" id="summaryText" style="margin:0">No data yet.</div>
        </div>

        <!-- LINKS BLOCK -->
        <div class="card2" id="blkLinks">
          <h3>Hyperlinks / Evidence</h3>
          <div class="help" style="margin:0">Links where VAT / buyer-type capture guidance was found (if available).</div>
          <ul id="sourcesList"><li class="help">No links yet.</li></ul>
        </div>

        <!-- COMPONENTS BLOCK -->
        <div class="card2" id="blkComponents">
          <h3>API & Components</h3>
          <div class="help" style="margin:0">Relevant endpoints/fields/UI components related to VAT & B2B detection.</div>
          <div class="tagrow" id="componentsTags"><span class="help">—</span></div>
          <ul id="componentsList" class="mono"></ul>
        </div>

        <!-- POSTMAN BLOCK -->
        <div class="card2" id="blkPostman">
          <h3>Postman Library</h3>
          <div id="postmanBlock" class="help" style="margin:0">—</div>
        </div>

        <div class="tiny mono" style="margin-top:12px">
          Backend expected: <strong>POST /api/analyze</strong> (multipart/form-data).
          This UI sends additional fields: <strong>targets[]</strong>, <strong>outputs[]</strong>, <strong>depth</strong>.
        </div>
      </section>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const setStatus = (txt) => {
      $("statusText").textContent = txt;
      const banner = $("bannerStatus");
      if(txt === "idle") banner.textContent = "Waiting for input…";
      else if(txt === "running") banner.textContent = "Running analysis…";
      else if(txt === "done") banner.textContent = "Done";
      else if(txt === "error") banner.textContent = "Error";
      else banner.textContent = txt;
    };

    function safeUrl(u){ try { new URL(u); return true; } catch { return false; } }

    function setYesNo(el, val){
      const txt = (val === true) ? "Yes" : (val === false) ? "No" : "—";
      el.textContent = txt;
      el.style.fontWeight = "900";
      el.style.color = (txt === "Yes") ? "var(--good)" : (txt === "No") ? "var(--bad)" : "var(--muted)";
    }

    // Toggle outcome blocks based on selection boxes
    function applyOutputVisibility(){
      $("blkYesNo").style.display = $("oYesNo").checked ? "" : "none";
      $("blkLinks").style.display = $("oLinks").checked ? "" : "none";
      $("blkComponents").style.display = $("oComponents").checked ? "" : "none";
      $("blkPostman").style.display = $("oPostman").checked ? "" : "none";

      const depth = $("depth").value;
      $("modeText").textContent =
        depth === "deep" ? "deep (more pages)" :
        depth === "pdf_only" ? "pdf only" :
        depth === "links_only" ? "links only" :
        "normal (fast)";
    }
    ["oYesNo","oLinks","oComponents","oPostman","depth"].forEach(id => {
      $(id).addEventListener("change", applyOutputVisibility);
    });

    // PDF UX
    const dropZone = $("dropZone");
    const pdfFile = $("pdfFile");
    const choosePdfBtn = $("choosePdfBtn");
    const pdfMeta = $("pdfMeta");

    function updatePdfMeta(){
      const f = pdfFile.files && pdfFile.files[0];
      pdfMeta.textContent = !f ? "No file selected." : `Selected: ${f.name} (${Math.round(f.size/1024)} KB)`;
    }

    choosePdfBtn.addEventListener("click", () => pdfFile.click());
    pdfFile.addEventListener("change", updatePdfMeta);

    ["dragenter","dragover"].forEach(evt => dropZone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropZone.style.borderColor = "rgba(124,58,237,.45)";
      dropZone.style.background = "#fff";
    }));
    ["dragleave","drop"].forEach(evt => dropZone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation();
      dropZone.style.borderColor = "var(--line)";
      dropZone.style.background = "var(--soft)";
    }));
    dropZone.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(!f) return;
      if(f.type !== "application/pdf"){ alert("Please drop a PDF file."); return; }
      pdfFile.files = e.dataTransfer.files;
      updatePdfMeta();
    });

    // Persistence
    const STORAGE_KEY = "vat_platform_validator_bedsizes_style_v2";
    function saveForm(){
      const data = {
        country: $("country").value,
        platform: $("platform").value,
        devSite: $("devSite").value,
        docsUrl: $("docsUrl").value,
        notes: $("notes").value,

        targets: {
          tVat: $("tVat").checked,
          tB2b: $("tB2b").checked,
          tInvoice: $("tInvoice").checked,
          tTaxLogic: $("tTaxLogic").checked,
          tExamples: $("tExamples").checked,
        },
        outputs: {
          oYesNo: $("oYesNo").checked,
          oLinks: $("oLinks").checked,
          oComponents: $("oComponents").checked,
          oPostman: $("oPostman").checked,
        },
        depth: $("depth").value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    function loadForm(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const d = JSON.parse(raw);
        $("country").value = d.country || "";
        $("platform").value = d.platform || "";
        $("devSite").value = d.devSite || "";
        $("docsUrl").value = d.docsUrl || "";
        $("notes").value = d.notes || "";
        if(d.targets){
          $("tVat").checked = !!d.targets.tVat;
          $("tB2b").checked = !!d.targets.tB2b;
          $("tInvoice").checked = !!d.targets.tInvoice;
          $("tTaxLogic").checked = !!d.targets.tTaxLogic;
          $("tExamples").checked = !!d.targets.tExamples;
        }
        if(d.outputs){
          $("oYesNo").checked = !!d.outputs.oYesNo;
          $("oLinks").checked = !!d.outputs.oLinks;
          $("oComponents").checked = !!d.outputs.oComponents;
          $("oPostman").checked = !!d.outputs.oPostman;
        }
        $("depth").value = d.depth || "normal";
      }catch{}
    }

    [
      "country","platform","devSite","docsUrl","notes",
      "tVat","tB2b","tInvoice","tTaxLogic","tExamples",
      "oYesNo","oLinks","oComponents","oPostman","depth"
    ].forEach(id => {
      $(id).addEventListener("input", saveForm);
      $(id).addEventListener("change", saveForm);
    });

    // Results rendering
    function clearResults(){
      $("runId").textContent = "—";
      ["foundInfo","possible","vatCapture","b2bFlag"].forEach(id => $(id).textContent = "—");
      $("confidence").textContent = "—";
      $("summaryText").textContent = "No data yet.";
      $("sourcesList").innerHTML = `<li class="help">No links yet.</li>`;
      $("componentsTags").innerHTML = `<span class="help">—</span>`;
      $("componentsList").innerHTML = "";
      $("postmanBlock").textContent = "—";

      const badge = $("confidenceBadge");
      badge.classList.remove("good","warn","bad");
      badge.classList.add("accent");
    }

    function renderResult(res){
      $("runId").textContent = res.runId || "—";

      setYesNo($("foundInfo"), res.foundInfo);
      setYesNo($("possible"), res.possible);
      setYesNo($("vatCapture"), res.vatCapture?.supported);
      setYesNo($("b2bFlag"), res.b2bFlag?.supported);

      const conf = (typeof res.confidence === "number")
        ? `${Math.round(res.confidence * 100)}%`
        : "—";
      $("confidence").textContent = conf;

      const badge = $("confidenceBadge");
      badge.classList.remove("accent","good","warn","bad");
      if(typeof res.confidence === "number"){
        if(res.confidence >= 0.8) badge.classList.add("good");
        else if(res.confidence >= 0.55) badge.classList.add("warn");
        else badge.classList.add("bad");
      } else {
        badge.classList.add("accent");
      }

      $("summaryText").textContent = res.summary || "—";

      // Sources
      const list = $("sourcesList");
      list.innerHTML = "";
      const sources = Array.isArray(res.sources) ? res.sources : [];
      if(!sources.length){
        list.innerHTML = `<li class="help">No links returned.</li>`;
      } else {
        sources.forEach(s => {
          const li = document.createElement("li");
          const title = s.title || s.url || "Source";
          if(s.url && safeUrl(s.url)){
            const a = document.createElement("a");
            a.href = s.url; a.target = "_blank"; a.rel="noreferrer";
            a.textContent = title;
            li.appendChild(a);
          } else {
            li.textContent = title;
          }
          list.appendChild(li);
        });
      }

      // API components
      const tags = $("componentsTags");
      const ul = $("componentsList");
      tags.innerHTML = "";
      ul.innerHTML = "";
      const comps = Array.isArray(res.apiComponents) ? res.apiComponents : [];
      if(!comps.length){
        tags.innerHTML = `<span class="help">—</span>`;
      } else {
        comps.slice(0, 10).forEach(c => {
          const t = document.createElement("span");
          t.className = "tag";
          t.textContent = c.name || "Component";
          tags.appendChild(t);
        });
        comps.forEach(c => {
          const li = document.createElement("li");
          const name = c.name ? `${c.name}: ` : "";
          li.textContent = name + (c.details || "");
          ul.appendChild(li);
        });
      }

      // Postman
      const pm = res.postman || {};
      const block = $("postmanBlock");
      if(pm.available === true){
        const parts = [];
        parts.push(`<span class="yn good"><strong>Available:</strong>&nbsp;Yes</span>`);
        if(pm.url && safeUrl(pm.url)){
          parts.push(`&nbsp;&nbsp;<a href="${pm.url}" target="_blank" rel="noreferrer">Open Postman library</a>`);
        }
        if(pm.generatedCollectionUrl && safeUrl(pm.generatedCollectionUrl)){
          parts.push(`&nbsp;•&nbsp;<a href="${pm.generatedCollectionUrl}" target="_blank" rel="noreferrer">Download generated collection</a>`);
        }
        block.innerHTML = parts.join("");
      } else if(pm.available === false){
        block.innerHTML = `<span class="yn bad"><strong>Available:</strong>&nbsp;No</span>`;
      } else {
        block.textContent = "—";
      }
    }

    // Collect selected fields
    function getSelectedTargets(){
      const out = [];
      if($("tVat").checked) out.push("vat_capture");
      if($("tB2b").checked) out.push("b2b_flag");
      if($("tInvoice").checked) out.push("invoice_billing_model");
      if($("tTaxLogic").checked) out.push("tax_logic");
      if($("tExamples").checked) out.push("examples_payloads");
      return out;
    }
    function getSelectedOutputs(){
      const out = [];
      if($("oYesNo").checked) out.push("yes_no");
      if($("oLinks").checked) out.push("links");
      if($("oComponents").checked) out.push("api_components");
      if($("oPostman").checked) out.push("postman");
      return out;
    }

    // Run
    const runBtn = $("runBtn");
    const resetBtn = $("resetBtn");

    resetBtn.addEventListener("click", () => {
      $("country").value = "";
      $("platform").value = "";
      $("devSite").value = "";
      $("docsUrl").value = "";
      $("notes").value = "";
      pdfFile.value = "";
      updatePdfMeta();
      localStorage.removeItem(STORAGE_KEY);
      clearResults();
      setStatus("idle");
      applyOutputVisibility();
    });

    runBtn.addEventListener("click", async () => {
      const country = $("country").value.trim();
      const platform = $("platform").value.trim();
      const devSite = $("devSite").value.trim();
      const docsUrl = $("docsUrl").value.trim();
      const notes = $("notes").value.trim();
      const pdf = pdfFile.files && pdfFile.files[0];

      if(!country || !platform){
        alert("Country and Platform name are required.");
        return;
      }
      if(devSite && !safeUrl(devSite)) { alert("Developer site URL is invalid."); return; }
      if(docsUrl && !safeUrl(docsUrl)) { alert("Docs URL is invalid."); return; }

      const targets = getSelectedTargets();
      const outputs = getSelectedOutputs();
      const depth = $("depth").value;

      if(targets.length === 0){
        alert("Select at least one validation target.");
        return;
      }
      if(outputs.length === 0){
        alert("Select at least one outcome block.");
        return;
      }

      runBtn.disabled = true;
      setStatus("running");
      clearResults();
      applyOutputVisibility();

      try{
        const fd = new FormData();
        fd.append("country", country);
        fd.append("platform", platform);
        if(devSite) fd.append("devSite", devSite);
        if(docsUrl) fd.append("docsUrl", docsUrl);
        if(notes) fd.append("notes", notes);
        if(pdf) fd.append("pdf", pdf);

        // new: selection boxes
        targets.forEach(t => fd.append("targets[]", t));
        outputs.forEach(o => fd.append("outputs[]", o));
        fd.append("depth", depth);

        const resp = await fetch("/api/analyze", { method: "POST", body: fd });

        if(!resp.ok){
          const txt = await resp.text();
          throw new Error(`Backend error (${resp.status}): ${txt.slice(0, 400)}`);
        }

        const json = await resp.json();
        renderResult(json);
        setStatus("done");
      }catch(err){
        console.error(err);
        setStatus("error");
        $("summaryText").textContent =
          "Run failed. Check console + backend logs. " +
          (err?.message ? `(${err.message})` : "");
        $("confidenceBadge").classList.remove("accent","good","warn");
        $("confidenceBadge").classList.add("bad");
      }finally{
        runBtn.disabled = false;
      }
    });

    // init
    loadForm();
    updatePdfMeta();
    clearResults();
    applyOutputVisibility();
    setStatus("idle");
  </script>
</body>
</html>
